---
title: "PrepCAISOData"
author: "James Woods"
date: "12/15/2014"
output: html_document
---

Read in the data from the CAISO

```{r}
OldWD<-getwd()
setwd("/home/woodsj/Forecast-Peak-With-Google-Trends/CAData/CAISO")
# Get the files names
files <- list.files(pattern="*.csv")

# First apply read.csv, then rbind
CAISORaw<- do.call("rbind", lapply(files, function(x) read.csv(x, stringsAsFactors = FALSE)))

```
Editing of data types.  Remember that most everything gets imported as a string.

```{r}

CAISORaw$MARKET_RUN_ID<-as.factor(CAISORaw$MARKET_RUN_ID)
CAISORaw$TAC_AREA_NAME<-as.factor(CAISORaw$TAC_AREA_NAME)
CAISORaw$StartTimeGMT<-as.POSIXct(CAISORaw$INTERVALSTARTTIME_GMT)
```
Now trim off all but the full ISO area

```{r}
CAISOWorking<-CAISORaw[CAISORaw$TAC_AREA_NAME=='CA ISO-TAC',]
save(CAISOWorking,file="CAISOWorking.Rdata")
```

Now lets sort out how the 7day ahead market is related to the actual

```{r}

CAISOWorking$Hour<-as.factor(CAISOWorking$OPR_HR)
CAISOWorking$Date<-as.Date(CAISOWorking$OPR_DT)
#line up actual and 7day with the time in the line

Forecast<-CAISOWorking[CAISOWorking$MARKET_RUN_ID=="7DA",]
Actual<-CAISOWorking[CAISOWorking$MARKET_RUN_ID=="ACTUAL",]

library(sqldf)

Current<-sqldf("select Actual.Hour, Actual.Date, Actual.MW as Actual, Forecast.MW as Forecast from Forecast, Actual where Actual.Hour=Forecast.Hour and Actual.Date=Forecast.Date;")
Lag<-sqldf("select Actual.Hour, Actual.Date, Actual.MW as Actual, Forecast.MW as Forecast from Forecast, Actual where Actual.Hour=Forecast.Hour and Actual.Date=(Forecast.Date+7);")

summary(lm(Actual~Forecast*Hour,data=Current))
summary(lm(Actual~Forecast*Hour,data=Lag))


```
Looks like they report what the 7day ahead forecast was rather than what it is.  In other words Jan 1 shows what they had forecasted seven days ago not what they expect on the 8th.

Now lets deal with why there are different numbers on the match.  Here is a table of the number of observations in each day.

```{r}
table(table(Current$Date))

```

That is an interesting pattern.  Guessing there were dups.  Checking the Working and Raw

```{r}
table(table(CAISOWorking$OPR_DT))
table(table(CAISORaw$OPR_DT))

```
Looks like we need a unique or something.

```{r}
table(table(unique(CAISOWorking)$OPR_DT))
table(table(CAISOWorking$OPR_DT))


table(table(CAISORaw$OPR_DT))
table(table(unique(CAISORaw)$OPR_DT))

```

Decide to only use the days with 48 obs.

```{r}


```





